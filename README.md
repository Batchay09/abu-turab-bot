# Abu Turab Bot

Telegram-бот для приёма религиозных вопросов с системой умного поиска похожих ответов.

## Возможности

- **Гибридный поиск** — комбинация семантического поиска (rubert-tiny-turbo + FAISS) и поиска по ключевым словам (BM25)
- **Синонимы исламских терминов** — автоматическое расширение запросов (намаз/салят, закят/закат и т.д.)
- **Очередь вопросов** — FIFO очередь с назначением на администраторов
- **Публикация в канал** — автоматическая нумерация и форматирование постов
- **Личный кабинет** — пользователи видят статус своих вопросов
- **Админ-панель** — управление очередью, ответы, теги

## Архитектура

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Пользователь  │────▶│   Telegram Bot   │────▶│  Админ-панель   │
│   задаёт вопрос │     │   (aiogram 3.x)  │     │  (в боте)       │
└─────────────────┘     └────────┬─────────┘     └─────────────────┘
                                 │
                    ┌────────────┼────────────┐
                    ▼            ▼            ▼
              ┌──────────┐ ┌──────────┐ ┌──────────┐
              │  SQLite  │ │  FAISS   │ │  Канал   │
              │    БД    │ │ + BM25   │ │ Telegram │
              └──────────┘ └──────────┘ └──────────┘
```

## Технологии

- **Python 3.11+**
- **aiogram 3.x** — асинхронный Telegram Bot API
- **SQLAlchemy 2.0** — ORM для SQLite
- **sentence-transformers** — модель `sergeyzh/rubert-tiny-turbo` для эмбеддингов
- **FAISS** — векторный поиск
- **rank-bm25** — поиск по ключевым словам
- **Pyrogram** — индексация канала

## Установка

1. Клонировать репозиторий:
```bash
git clone https://github.com/yourusername/abu-turab-bot.git
cd abu-turab-bot
```

2. Создать виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate  # Windows
```

3. Установить зависимости:
```bash
pip install -r requirements.txt
```

4. Создать файл `.env`:
```env
BOT_TOKEN=your_bot_token
CHANNEL_ID=-1001234567890
CHANNEL_USERNAME=your_channel
BOT_USERNAME=your_bot
ADMIN_IDS=123456789,987654321
API_ID=your_api_id
API_HASH=your_api_hash
```

5. Запустить бота:
```bash
python bot.py
```

## Индексация канала

Для первоначальной индексации существующих постов:

```bash
python -m services.indexer
```

## Структура проекта

```
abu_turab/
├── bot.py                    # Точка входа
├── config.py                 # Конфигурация
├── requirements.txt
│
├── database/
│   ├── connection.py         # Подключение к БД
│   └── models.py             # Модели данных
│
├── handlers/
│   ├── user.py               # Хендлеры пользователя
│   ├── admin.py              # Админ-панель
│   └── common.py             # Общие команды
│
├── services/
│   ├── search_engine.py      # Гибридный поиск (FAISS + BM25)
│   ├── synonyms.py           # Словарь синонимов
│   ├── question_service.py   # Управление очередью
│   ├── channel_service.py    # Постинг в канал
│   └── indexer.py            # Индексация канала
│
├── states/
│   └── states.py             # FSM состояния
│
└── templates/
    └── messages.py           # Шаблоны сообщений
```

## Как работает поиск

1. **Пользователь задаёт вопрос**
2. **Расширение запроса** — добавляются синонимы исламских терминов
3. **Семантический поиск** — FAISS находит похожие по смыслу документы
4. **Поиск по ключевым словам** — BM25 находит точные совпадения слов
5. **Объединение результатов** — Reciprocal Rank Fusion (RRF) комбинирует оба списка
6. **Показ результатов** — пользователь видит релевантные ответы

## Лицензия

MIT

## Автор

Разработано с использованием Claude Code.
