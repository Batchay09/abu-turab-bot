# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Обзор проекта

Abu Turab — Telegram-бот для приёма религиозных вопросов по исламу на Python. Пользователи задают вопросы, администраторы отвечают на них, ответы публикуются в Telegram-канал. Бот использует гибридный поиск (FAISS + BM25) для поиска похожих ранее отвеченных вопросов.

**Язык интерфейса**: Русский (весь текст для пользователей)
**ML-модель**: `sergeyzh/rubert-tiny-turbo` (312-мерные русскоязычные эмбеддинги)

## Команды

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск бота
python bot.py

# Индексация постов канала (ИНТЕРАКТИВНЫЙ - запускать вручную в терминале)
# Требует ввод номера телефона и кода из Telegram
python indexer.py

# Импорт Q&A из JSON-экспорта Telegram Desktop
python import_from_json.py /path/to/result.json
```

## Настройка окружения

Скопировать `.env.example` в `.env` и настроить:
- `BOT_TOKEN` — от @BotFather
- `CHANNEL_ID`, `CHANNEL_USERNAME` — канал для публикации ответов
- `ADMIN_IDS` — ID администраторов через запятую
- `API_ID`, `API_HASH` — от my.telegram.org (только для indexer.py)

## Архитектура

```
bot.py              # Точка входа — инициализация БД, поиска, регистрация роутеров
config.py           # Конфигурация из переменных окружения

database/
  models.py         # SQLAlchemy модели: User, Question, ChannelPost, Tag, SelfAnsweredLog
  connection.py     # Асинхронное подключение к SQLite (aiosqlite)

services/
  search_engine.py  # Гибридный поиск: FAISS семантика + BM25 ключевые слова (singleton)
  question_service.py # CRUD операции с вопросами
  channel_service.py  # Публикация и форматирование постов в канал
  tag_service.py      # Управление тегами/категориями
  tag_suggester.py    # Автоматическое предложение тегов по ключевым словам
  user_service.py     # Регистрация пользователей и проверка прав
  synonyms.py         # Расширение синонимов исламских терминов (100+ терминов)

handlers/
  common.py         # /start, /help, отмена, главное меню
  user.py           # Флоу отправки вопроса с поиском похожих
  admin.py          # Админ-панель, очередь, ответы на вопросы

states/
  states.py         # FSM состояния для многошаговых диалогов

templates/
  messages.py       # Все текстовые сообщения бота (на русском)

data/               # Данные времени выполнения (создаются автоматически)
  bot.db            # SQLite база данных
  faiss_questions.index   # Эмбеддинги вопросов
  faiss_answers.index     # Эмбеддинги ответов
  faiss_combined.index    # Взвешенная комбинация (60% вопрос + 40% ответ)
  documents.json    # Метаданные документов для поиска
```

## Система гибридного поиска

Поисковый движок комбинирует несколько методов:
1. **Мульти-векторный FAISS**: Отдельные индексы для вопросов, ответов и взвешенной комбинации (предотвращает смещение в сторону длинных ответов)
2. **BM25 поиск по ключевым словам**: Точное совпадение терминов с TF-IDF ранжированием
3. **Расширение синонимов**: Автоматическое расширение запросов для исламских терминов (намаз→салят, закят→закат)
4. **Reciprocal Rank Fusion (RRF)**: Объединяет семантические (30%) и ключевые (70%) результаты

## Ключевые паттерны

- **FSM (конечный автомат)**: aiogram FSM для многошаговых диалогов (отправка вопроса, ответ админа)
- **Service Layer**: Бизнес-логика в `services/`, хендлеры только координируют
- **Singleton Search Engine**: Глобальный экземпляр `search_engine` в `services/search_engine.py`
- **Async везде**: Все операции с БД и Telegram API через async/await
- **CallbackData классы**: Структурированные данные для inline-кнопок

## Флоу вопроса

1. Пользователь задаёт вопрос → гибридный поиск показывает похожие ответы
2. Если пользователь нашёл ответ через поиск → логируется как "self-answered" (аналитика)
3. Иначе вопрос сохраняется со статусом `pending`
4. Админ берёт вопрос (`in_progress`), пишет ответ, выбирает теги (авто-предложение)
5. Админ выбирает назначение: личный ответ или публикация в канал
6. Опубликованные посты получают порядковые номера (#1, #2, ...) и индексируются

## Модели базы данных

- **User**: Пользователи Telegram с флагами `is_admin`, `is_banned`
- **Question**: Прогрессия статусов: `pending` → `in_progress` → `answered_public`/`answered_private`/`rejected`/`self_answered`
- **ChannelPost**: Опубликованные Q&A с порядковым `post_number`
- **Tag**: 24 предустановленных исламских категории (столпы ислама, разделы фикха, акыда и т.д.)
- **SelfAnsweredLog**: Отслеживает когда пользователи находят ответы через поиск без участия админа

## Примечания

- Используется MemoryStorage для FSM; в `bot.py` есть комментарий о необходимости Redis для multi-worker деплоя
- Порог поиска настраивается в `config.py`: `SIMILARITY_THRESHOLD = 0.65`
- Расширение синонимов в `services/synonyms.py` покрывает 100+ исламских терминов с многоязычными альтернативами
